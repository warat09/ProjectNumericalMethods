name: CI
on: [push]
jobs:
    install-and-test:
      runs-on: ubuntu-latest

      strategy:
        matrix:
          node-version: [17.x]

      steps:
        - uses: actions/checkout@master

        - name: Set up Node.js ${{ matrix.node-version }}
          uses: actions/setup-node@master
          with:
            node-version: ${{ matrix.node-version }}

        - name: Install packages
          run: yarn install --frozen-lockfile
          
        - name: Test
          run: yarn test
    
          env:
            CI: true
            
        - name: Checkout 
          uses: actions/checkout@v2
          
        - name: Login to Docker Hub
          uses: docker/login-action@v1
          with:
            username: ${{ secrets.DOCKER_HUB_USERNAME }}
            password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
          
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v1
          
        - name: Build and push
          uses: docker/build-push-action@v2
          with:
            context: .
            file: ./Dockerfile
            push: true
            tags: ${{ secrets.DOCKER_HUB_USERNAME }}/client:latest

        - name: Deploy
          needs: build
          runs-on: ubuntu-latest
          steps:
        - name: Download artifact
          uses: actions/download-artifact@v2
          with:
            name: production
            path: ./build
              
        - name: Deploy to Github pages
          uses: warat09/ghaction-github-pages@v2
          with:
            target_branch: numerpage
            build_dir: ./build
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
